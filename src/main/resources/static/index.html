<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <title>Graph Viewer</title>-->
<!--    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>-->
<!--    <style>-->
<!--        body {-->
<!--            font-family: Arial, sans-serif;-->
<!--            margin: 20px;-->
<!--        }-->
<!--        #graph {-->
<!--            width: 100%;-->
<!--            height: 600px;-->
<!--            border: 1px solid lightgray;-->
<!--            margin-top: 20px;-->
<!--        }-->
<!--        #controls {-->
<!--            margin-bottom: 15px;-->
<!--        }-->
<!--        input, select, button {-->
<!--            padding: 6px;-->
<!--            margin-right: 5px;-->
<!--        }-->
<!--        #error {-->
<!--            color: red;-->
<!--            font-weight: bold;-->
<!--        }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->
<!--<h2>Company/Person Graph Viewer</h2>-->

<!--<div id="controls">-->
<!--    <label for="type">Type:</label>-->
<!--    <select id="type">-->
<!--        <option value="company">Company</option>-->
<!--        <option value="person">Person</option>-->
<!--    </select>-->

<!--    <label for="regNumber">Reg Number:</label>-->
<!--    <input type="text" id="regNumber" placeholder="e.g. REG10001" />-->

<!--    <button onclick="loadGraph()">Load Graph</button>-->
<!--</div>-->

<!--<div id="error"></div>-->
<!--<div id="graph"></div>-->

<!--<script>-->
<!--    function loadGraph() {-->
<!--        const type = document.getElementById("type").value;-->
<!--        const regNumber = document.getElementById("regNumber").value.trim();-->
<!--        const errorDiv = document.getElementById("error");-->
<!--        errorDiv.textContent = "";-->

<!--        if (!regNumber) {-->
<!--            errorDiv.textContent = "⚠️ Please enter a registration number!";-->
<!--            return;-->
<!--        }-->

<!--        fetch(`http://localhost:8081/api/graph/${type}/${regNumber}`)-->
<!--            .then(response => {-->
<!--                if (!response.ok) {-->
<!--                    throw new Error("Serverdan xato javob keldi (" + response.status + ")");-->
<!--                }-->
<!--                return response.json();-->
<!--            })-->
<!--            .then(data => {-->
<!--                drawGraph(data);-->
<!--            })-->
<!--            .catch(error => {-->
<!--                errorDiv.textContent = error.message;-->
<!--            });-->
<!--    }-->

<!--    function drawGraph(data) {-->
<!--        const nodes = new vis.DataSet(data.nodes.map(n => ({-->
<!--            id: n.id,-->
<!--            label: n.label,-->
<!--            color: n.type === "PERSON" ? "#ffcc00" : "#66ccff",-->
<!--            shape: n.type === "PERSON" ? "ellipse" : "box"-->
<!--        })));-->

<!--        const edges = new vis.DataSet(data.edges.map(e => ({-->
<!--            from: e.from,-->
<!--            to: e.to,-->
<!--            label: e.label,-->
<!--            arrows: "to"-->
<!--        })));-->

<!--        const container = document.getElementById("graph");-->
<!--        const networkData = { nodes, edges };-->
<!--        const options = {-->
<!--            physics: {-->
<!--                enabled: true,-->
<!--                stabilization: { iterations: 100 }-->
<!--            },-->
<!--            edges: {-->
<!--                font: { align: "middle" },-->
<!--                smooth: true-->
<!--            }-->
<!--        };-->

<!--        new vis.Network(container, networkData, options);-->
<!--    }-->
<!--</script>-->
<!--</body>-->
<!--</html>-->


<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8" />
    <title>Graph Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #toolbar { margin-bottom: 12px; }
        input, button { padding: 8px; font-size: 14px; }
        svg { width: 100%; height: 640px; border: 1px solid #ddd; }
        circle { stroke: #333; stroke-width: 1.5px; }
        .company { fill: #8fd3ff; }
        .person  { fill: #a7e9af; }
        line { stroke: #999; stroke-opacity: 0.6; }
        .legend { margin-top: 8px; font-size: 14px; color: #555; }
        .badge { display:inline-block; padding:2px 8px; border-radius:12px; margin-right:8px; }
        .b-company { background:#8fd3ff; }
        .b-person  { background:#a7e9af; }
    </style>
</head>
<body>
<h2>Company / Person — To‘liq Graph</h2>
<div id="toolbar">
    <input id="search" placeholder="INN yoki PINFL kiriting (masalan: REG10001 yoki 12345678901234)" size="50"/>
    <button onclick="search()">Qidirish</button>
</div>
<div class="legend">
    <span class="badge b-company">COMPANY</span>
    <span class="badge b-person">PERSON</span>
</div>
<svg id="canvas"></svg>

<script>
    function search() {
        const value = document.getElementById("search").value.trim();
        if (!value) { alert("INN yoki PINFL kiriting!"); return; }

        // Agar index.html Spring Boot static papkadan servis qilinsa, nisbiy URL yetarli:
        const url = `/api/v1/graph/${encodeURIComponent(value)}`;

        fetch(url)
            .then(res => {
                if (!res.ok) throw new Error("Serverdan xato javob keldi (" + res.status + ")");
                return res.json();
            })
            .then(drawGraph)
            .catch(err => {
                alert("Graphni yuklashda xatolik yuz berdi: " + err.message);
                console.error(err);
            });
    }

    function drawGraph(graph) {
        const svg = d3.select("#canvas");
        svg.selectAll("*").remove();

        // --- data mapping (MUHIM: from/to!)
        const links = (graph.edges || []).map(e => ({ source: e.from, target: e.to, label: e.label }));
        const nodeMap = {};
        (graph.nodes || []).forEach(n => { nodeMap[n.id] = n; });

        const nodes = Object.values(nodeMap);
        if (nodes.length === 0) {
            alert("Hech qanday tugun topilmadi.");
            return;
        }

        // force simulation
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(140))
            .force("charge", d3.forceManyBody().strength(-450))
            .force("center", d3.forceCenter(svg.node().clientWidth / 2, svg.node().clientHeight / 2));

        // edges
        const link = svg.append("g").attr("stroke-width", 1.5)
            .selectAll("line")
            .data(links)
            .enter().append("line");

        // nodes
        const node = svg.append("g")
            .selectAll("circle")
            .data(nodes)
            .enter().append("circle")
            .attr("r", 20)
            .attr("class", d => (d.type || "").toLowerCase())
            .call(drag(simulation));

        // labels (node)
        const label = svg.append("g")
            .selectAll("text")
            .data(nodes)
            .enter().append("text")
            .text(d => d.label)
            .attr("font-size", 12)
            .attr("text-anchor", "middle")
            .attr("dy", -28);

        simulation.on("tick", () => {
            link
                .attr("x1", d => pos(d.source, 'x'))
                .attr("y1", d => pos(d.source, 'y'))
                .attr("x2", d => pos(d.target, 'x'))
                .attr("y2", d => pos(d.target, 'y'));

            node.attr("cx", d => d.x).attr("cy", d => d.y);
            label.attr("x", d => d.x).attr("y", d => d.y);
        });

        function pos(obj, key) {
            // d3 ba’zida id string bo‘ladi; mapdan obyektini olib kelamiz
            if (typeof obj === "string" && nodeMap[obj]) return nodeMap[obj][key];
            return obj[key];
        }

        function drag(sim) {
            return d3.drag()
                .on("start", (event) => {
                    if (!event.active) sim.alphaTarget(0.3).restart();
                    event.subject.fx = event.subject.x;
                    event.subject.fy = event.subject.y;
                })
                .on("drag", (event) => {
                    event.subject.fx = event.x;
                    event.subject.fy = event.y;
                })
                .on("end", (event) => {
                    if (!event.active) sim.alphaTarget(0);
                    event.subject.fx = null;
                    event.subject.fy = null;
                });
        }
    }
</script>
</body>
</html>

