<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8" />
    <title>Graph Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #toolbar { margin-bottom: 12px; }
        input, button { padding: 8px; font-size: 14px; margin-right: 5px; }
        svg { width: 100%; height: 640px; border: 1px solid #ddd; }
        circle { stroke: #333; stroke-width: 1.5px; }
        .company { fill: #8fd3ff; }
        .person  { fill: #a7e9af; }
        line { stroke: #999; stroke-opacity: 0.6; }
        .legend { margin-top: 8px; font-size: 14px; color: #555; }
        .badge { display:inline-block; padding:2px 8px; border-radius:12px; margin-right:8px; }
        .b-company { background:#8fd3ff; }
        .b-person  { background:#a7e9af; }
        .highlight { stroke: red !important; stroke-width: 3px !important; }
    </style>
</head>
<body>
<h2>Company / Person — To‘liq Graph</h2>
<div id="toolbar">
    <input id="search" placeholder="INN yoki PINFL kiriting (masalan: REG10001 yoki 12345678901234)" size="50"/>
    <button onclick="search()">Qidirish</button>
    <button onclick="resetHighlight()">Reset</button>
    <button onclick="zoomIn()">+</button>
    <button onclick="zoomOut()">-</button>
</div>
<div class="legend">
    <span class="badge b-company">COMPANY</span>
    <span class="badge b-person">PERSON</span>
</div>
<svg id="canvas"></svg>

<script>
    const svg = d3.select("#canvas");
    const g = svg.append("g"); // zoom uchun group

    const zoom = d3.zoom()
        .scaleExtent([0.3, 4])
        .on("zoom", (event) => {
            g.attr("transform", event.transform);
        });

    svg.call(zoom);

    function search() {
        const value = document.getElementById("search").value.trim();
        if (!value) { alert("INN yoki PINFL kiriting!"); return; }

        const url = `http://localhost:8080/api/v1/graph/${encodeURIComponent(value)}`;

        fetch(url)
            .then(res => {
                if (!res.ok) throw new Error("Serverdan xato javob keldi (" + res.status + ")");
                return res.json();
            })
            .then(drawGraph)
            .catch(err => {
                alert("Graphni yuklashda xatolik yuz berdi: " + err.message);
                console.error(err);
            });
    }

    function drawGraph(graph) {
        g.selectAll("*").remove();

        const links = (graph.edges || []).map(e => ({ source: e.from, target: e.to, label: e.label }));
        const nodeMap = {};
        (graph.nodes || []).forEach(n => { nodeMap[n.id] = {...n}; });

        // --- Node labelga F yoki D qo‘shib qo‘yamiz
        links.forEach(e => {
            if (e.label === "FOUNDER" && nodeMap[e.source] && nodeMap[e.source].type === "PERSON") {
                nodeMap[e.source].label += " (F)";
            }
            if (e.label === "DIRECTOR" && nodeMap[e.source] && nodeMap[e.source].type === "PERSON") {
                nodeMap[e.source].label += " (D)";
            }
        });

        const nodes = Object.values(nodeMap);
        if (nodes.length === 0) {
            alert("Hech qanday tugun topilmadi.");
            return;
        }

        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(140))
            .force("charge", d3.forceManyBody().strength(-450))
            .force("center", d3.forceCenter(svg.node().clientWidth / 2, svg.node().clientHeight / 2));

        const link = g.append("g").attr("stroke-width", 1.5)
            .selectAll("line")
            .data(links)
            .enter().append("line");

        const node = g.append("g")
            .selectAll("circle")
            .data(nodes)
            .enter().append("circle")
            .attr("r", 20)
            .attr("class", d => (d.type || "").toLowerCase())
            .call(drag(simulation));

        const label = g.append("g")
            .selectAll("text")
            .data(nodes)
            .enter().append("text")
            .text(d => d.label)
            .attr("font-size", 12)
            .attr("text-anchor", "middle")
            .attr("dy", -28);

        simulation.on("tick", () => {
            link
                .attr("x1", d => pos(d.source, 'x'))
                .attr("y1", d => pos(d.source, 'y'))
                .attr("x2", d => pos(d.target, 'x'))
                .attr("y2", d => pos(d.target, 'y'));

            node.attr("cx", d => d.x).attr("cy", d => d.y);
            label.attr("x", d => d.x).attr("y", d => d.y);
        });

        // highlight qidiruv
        document.getElementById("search").addEventListener("input", function() {
            const text = this.value.toLowerCase();
            node.classed("highlight", d => d.label.toLowerCase().includes(text));
        });

        function pos(obj, key) {
            if (typeof obj === "string" && nodeMap[obj]) return nodeMap[obj][key];
            return obj[key];
        }

        function drag(sim) {
            return d3.drag()
                .on("start", (event) => {
                    if (!event.active) sim.alphaTarget(0.3).restart();
                    event.subject.fx = event.subject.x;
                    event.subject.fy = event.subject.y;
                })
                .on("drag", (event) => {
                    event.subject.fx = event.x;
                    event.subject.fy = event.y;
                })
                .on("end", (event) => {
                    if (!event.active) sim.alphaTarget(0);
                    event.subject.fx = null;
                    event.subject.fy = null;
                });
        }
    }

    function resetHighlight() {
        g.selectAll("circle").classed("highlight", false);
        document.getElementById("search").value = "";
    }

    function zoomIn() {
        svg.transition().call(zoom.scaleBy, 1.2);
    }
    function zoomOut() {
        svg.transition().call(zoom.scaleBy, 0.8);
    }
</script>
</body>
</html>
